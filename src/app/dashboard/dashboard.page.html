<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Dashboard</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Streak Celebration Overlay -->
  <div *ngIf="showStreakCelebration" class="streak-celebration">
    <div class="celebration-content">
      <div class="flame-icon">ðŸ”¥</div>
      <h2>Amazing Streak!</h2>
      <p>{{ userProgress?.currentStreak }} days and counting!</p>
    </div>
  </div>

  <!-- Welcome Header with Streak -->
  <div class="welcome-header">
    <div class="welcome-text">
      <h1 class="gradient-text">Hello, Learner! ðŸš€</h1>
      <p>Ready to crush your goals today?</p>
    </div>

    <!-- Streak Badge -->
    <div
      *ngIf="userProgress && userProgress.currentStreak > 0"
      class="streak-badge"
      (click)="triggerStreakCelebration()"
    >
      <ion-icon name="flame-outline"></ion-icon>
      <span class="streak-count">{{ userProgress.currentStreak }}</span>
      <span class="streak-label">day streak</span>
    </div>
  </div>

  <!-- Quick Stats -->
  <div *ngIf="userProgress && !isLoading" class="quick-stats">
    <div class="stat-card">
      <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
      <div class="stat-info">
        <span class="stat-value">{{ userProgress.totalStepsCompleted }}</span>
        <span class="stat-label">Steps Done</span>
      </div>
    </div>
    <div class="stat-card">
      <ion-icon name="trophy-outline" color="warning"></ion-icon>
      <div class="stat-info">
        <span class="stat-value">{{ userProgress.longestStreak }}</span>
        <span class="stat-label">Best Streak</span>
      </div>
    </div>
    <div class="stat-card">
      <ion-icon name="create-outline" color="tertiary"></ion-icon>
      <div class="stat-info">
        <span class="stat-value">{{ userProgress.totalNotesAdded }}</span>
        <span class="stat-label">Notes</span>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Loading your learning paths...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && learningTopics.length === 0" class="empty-state">
    <div class="empty-state-icon">
      <ion-icon name="rocket-outline"></ion-icon>
    </div>
    <h2>Start Your Learning Journey</h2>
    <p>
      You haven't added any skills yet. Create your first personalized learning
      roadmap powered by AI!
    </p>
    <ion-button
      expand="block"
      (click)="navigateToAddSkill()"
      class="cta-button"
    >
      <ion-icon slot="start" name="add-circle-outline"></ion-icon>
      Add Your First Skill
    </ion-button>
  </div>

  <!-- Learning Paths -->
  <div *ngIf="!isLoading && learningTopics.length > 0">
    <div class="section-header">
      <h2>My Learning Roadmaps</h2>
      <ion-button fill="clear" size="small" (click)="navigateToAddSkill()">
        <ion-icon slot="start" name="add-circle-outline"></ion-icon>
        Add New
      </ion-button>
    </div>

    <ion-item-sliding *ngFor="let topic of learningTopics">
      <ion-item-options side="end">
        <ion-item-option color="danger" (click)="confirmDeleteRoadmap(topic)">
          <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
        </ion-item-option>
      </ion-item-options>

      <ion-item lines="none" class="roadmap-item">
        <div class="roadmap-card">
          <!-- Roadmap Header -->
          <div
            class="roadmap-header"
            (click)="topic.expanded = !topic.expanded"
          >
            <div class="roadmap-info">
              <h3>{{ topic.title }}</h3>
              <div class="roadmap-meta">
                <ion-chip
                  [color]="topic.status === 'Completed' ? 'success' : (topic.status === 'Not Started' ? 'medium' : 'primary')"
                  size="small"
                >
                  {{ topic.status }}
                </ion-chip>
                <span class="category-tag"
                  >{{ getCategoryLabel(topic.category) }}</span
                >
              </div>
            </div>
            <div class="roadmap-progress-circle">
              <svg viewBox="0 0 36 36">
                <path
                  class="circle-bg"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                />
                <path
                  class="circle-progress"
                  [attr.stroke-dasharray]="(topic.progress * 100) + ', 100'"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                />
              </svg>
              <span class="progress-text"
                >{{ (topic.progress * 100) | number:'1.0-0' }}%</span
              >
            </div>
            <ion-icon
              [name]="topic.expanded ? 'chevron-up-outline' : 'chevron-down-outline'"
              class="expand-icon"
            ></ion-icon>
          </div>

          <!-- Roadmap Actions -->
          <div class="roadmap-actions">
            <ion-button
              fill="clear"
              size="small"
              (click)="openShareModal(topic); $event.stopPropagation()"
            >
              <ion-icon slot="start" name="share-outline"></ion-icon>
              Share
            </ion-button>
            <ion-button
              fill="clear"
              size="small"
              (click)="exportToPDF(topic); $event.stopPropagation()"
            >
              <ion-icon slot="start" name="download-outline"></ion-icon>
              Export
            </ion-button>
          </div>

          <!-- Progress Summary -->
          <div class="progress-summary">
            <div class="progress-stats">
              <span class="steps-count"
                >{{ getCompletedSteps(topic) }}/{{ topic.subtasks.length }}
                steps</span
              >
              <span
                *ngIf="topic.resourcesStatus === 'loading' || topic.resourcesStatus === 'pending'"
                class="resources-badge resources-loading-badge"
              >
                <ion-spinner name="dots" color="primary"></ion-spinner>
                Gathering...
              </span>
              <span
                *ngIf="topic.resourcesStatus === 'ready'"
                class="resources-badge resources-ready-badge"
              >
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                {{ getCompletedResourceCount(topic) }}/{{
                getTotalResourceCount(topic) }} resources
              </span>
            </div>
          </div>

          <!-- Roadmap Timeline -->
          <div *ngIf="topic.expanded" class="roadmap-timeline">
            <div
              *ngFor="let step of topic.subtasks; let i = index; let last = last"
              class="timeline-step"
              [class.completed]="step.completed"
            >
              <!-- Timeline Connector -->
              <div class="timeline-connector">
                <div class="step-number" [class.completed]="step.completed">
                  <ion-icon *ngIf="step.completed" name="checkmark"></ion-icon>
                  <span *ngIf="!step.completed">{{ i + 1 }}</span>
                </div>
                <div
                  *ngIf="!last"
                  class="connector-line"
                  [class.completed]="step.completed"
                ></div>
              </div>

              <!-- Step Content -->
              <div class="step-content" [class.completed]="step.completed">
                <div
                  class="step-header"
                  (click)="step.expanded = !step.expanded"
                >
                  <div class="step-info">
                    <h4>{{ step.title }}</h4>
                    <div class="step-meta">
                      <span *ngIf="step.estimatedTime" class="time-badge">
                        <ion-icon name="time-outline"></ion-icon>
                        {{ step.estimatedTime }}
                      </span>
                      <span
                        *ngIf="step.notes && step.notes.length > 0"
                        class="notes-badge"
                      >
                        <ion-icon name="create-outline"></ion-icon>
                        {{ step.notes.length }}
                      </span>
                    </div>
                  </div>
                  <div class="step-actions">
                    <!-- Bookmark Button -->
                    <ion-button
                      fill="clear"
                      size="small"
                      [color]="step.bookmarked ? 'warning' : 'medium'"
                      (click)="toggleBookmark(topic, step); $event.stopPropagation()"
                    >
                      <ion-icon
                        slot="icon-only"
                        [name]="step.bookmarked ? 'bookmark' : 'bookmark-outline'"
                      ></ion-icon>
                    </ion-button>
                    <ion-checkbox
                      [checked]="step.completed"
                      (ionChange)="onSubtaskChange($event, step, topic)"
                      (click)="$event.stopPropagation()"
                    ></ion-checkbox>
                  </div>
                </div>

                <!-- Expanded Content -->
                <div *ngIf="step.expanded" class="step-details">
                  <p class="step-description" *ngIf="step.description">
                    {{ step.description }}
                  </p>

                  <!-- Notes Section -->
                  <div class="notes-section">
                    <div
                      class="notes-header"
                      (click)="toggleNotes(step); $event.stopPropagation()"
                    >
                      <h5>
                        <ion-icon name="create-outline"></ion-icon>
                        Notes
                        <ion-badge
                          *ngIf="step.notes && step.notes.length > 0"
                          color="tertiary"
                        >
                          {{ step.notes.length }}
                        </ion-badge>
                      </h5>
                      <ion-icon
                        [name]="step.showNotes ? 'chevron-up-outline' : 'chevron-down-outline'"
                      ></ion-icon>
                    </div>

                    <div *ngIf="step.showNotes" class="notes-content">
                      <!-- Existing Notes -->
                      <div *ngFor="let note of step.notes" class="note-item">
                        <p>{{ note.content }}</p>
                        <div class="note-footer">
                          <span class="note-date"
                            >{{ note.createdAt | date:'short' }}</span
                          >
                          <ion-button
                            fill="clear"
                            size="small"
                            color="danger"
                            (click)="deleteNote(topic, step, note)"
                          >
                            <ion-icon
                              slot="icon-only"
                              name="trash-outline"
                            ></ion-icon>
                          </ion-button>
                        </div>
                      </div>

                      <!-- Add Note Form -->
                      <div class="add-note-form">
                        <ion-textarea
                          [(ngModel)]="step.newNoteContent"
                          placeholder="Add a note..."
                          [autoGrow]="true"
                          rows="2"
                        ></ion-textarea>
                        <ion-button
                          fill="solid"
                          size="small"
                          (click)="addNote(topic, step)"
                          [disabled]="!step.newNoteContent || step.newNoteContent.trim().length === 0"
                        >
                          <ion-icon slot="start" name="add-outline"></ion-icon>
                          Add Note
                        </ion-button>
                      </div>
                    </div>
                  </div>

                  <!-- Resources Loading State -->
                  <div
                    *ngIf="isResourcesLoading(step)"
                    class="resources-loading"
                  >
                    <div class="loading-animation">
                      <ion-spinner
                        name="crescent"
                        color="primary"
                      ></ion-spinner>
                    </div>
                    <div class="loading-text">
                      <h5>Gathering verified resources...</h5>
                      <p>
                        Finding and validating the best learning materials for
                        you
                      </p>
                    </div>
                    <div class="skeleton-resources">
                      <ion-skeleton-text
                        [animated]="true"
                        style="width: 100%; height: 50px; border-radius: 8px"
                      ></ion-skeleton-text>
                      <ion-skeleton-text
                        [animated]="true"
                        style="width: 100%; height: 50px; border-radius: 8px"
                      ></ion-skeleton-text>
                      <ion-skeleton-text
                        [animated]="true"
                        style="width: 80%; height: 50px; border-radius: 8px"
                      ></ion-skeleton-text>
                    </div>
                  </div>

                  <!-- Resources Failed State -->
                  <div
                    *ngIf="step.resourcesStatus === 'failed' && (!step.resources || step.resources.length === 0)"
                    class="resources-failed"
                  >
                    <ion-icon
                      name="alert-circle-outline"
                      color="warning"
                    ></ion-icon>
                    <p>Some resources couldn't be verified</p>
                    <ion-button
                      fill="clear"
                      size="small"
                      (click)="retryResourceGathering(topic); $event.stopPropagation()"
                    >
                      <ion-icon slot="start" name="refresh-outline"></ion-icon>
                      Retry
                    </ion-button>
                  </div>

                  <!-- Resources Grid -->
                  <div
                    *ngIf="step.resourcesStatus === 'ready' && step.resources && step.resources.length > 0"
                    class="resources-section"
                  >
                    <h5>
                      <ion-icon name="book-outline"></ion-icon>
                      Verified Resources
                      <ion-badge color="success" style="margin-left: 8px"
                        >{{ step.resources.length }}</ion-badge
                      >
                    </h5>
                    <div class="resources-grid">
                      <div
                        *ngFor="let resource of step.resources"
                        class="resource-card"
                        (click)="openResource(resource.url)"
                      >
                        <div
                          class="resource-icon"
                          [attr.data-type]="resource.type"
                        >
                          <ion-icon
                            [name]="getResourceIcon(resource.type)"
                          ></ion-icon>
                        </div>
                        <div class="resource-info">
                          <span class="resource-title"
                            >{{ resource.title }}</span
                          >
                          <span class="resource-type">{{ resource.type }}</span>
                        </div>
                        <ion-icon
                          name="open-outline"
                          class="open-icon"
                        ></ion-icon>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ion-item>
    </ion-item-sliding>
  </div>

  <!-- Share Modal -->
  <ion-modal [isOpen]="shareModalOpen" (didDismiss)="closeShareModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Share Roadmap</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeShareModal()">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div class="share-modal-content" *ngIf="shareModalTopic">
          <div class="share-preview">
            <h3>{{ shareModalTopic.title }}</h3>
            <p>{{ shareModalTopic.learningGoal || 'Learning roadmap' }}</p>
            <div class="share-stats">
              <span>{{ shareModalTopic.subtasks.length }} steps</span>
              <span>{{ getCategoryLabel(shareModalTopic.category) }}</span>
            </div>
          </div>

          <div class="share-link-section">
            <h4>Share Link</h4>
            <div class="share-link-input">
              <input type="text" [value]="shareUrl" readonly />
              <ion-button fill="solid" (click)="copyShareLink()">
                <ion-icon slot="icon-only" name="copy-outline"></ion-icon>
              </ion-button>
            </div>
          </div>

          <div class="share-social-section">
            <h4>Share on Social</h4>
            <div class="social-buttons">
              <ion-button
                fill="outline"
                color="primary"
                (click)="shareToTwitter()"
              >
                <ion-icon slot="start" name="logo-twitter"></ion-icon>
                Twitter
              </ion-button>
              <ion-button
                fill="outline"
                color="primary"
                (click)="shareToLinkedIn()"
              >
                <ion-icon slot="start" name="logo-linkedin"></ion-icon>
                LinkedIn
              </ion-button>
            </div>
          </div>

          <div class="share-options">
            <ion-button
              *ngIf="shareModalTopic.isPublic"
              fill="clear"
              color="danger"
              expand="block"
              (click)="disableSharing(shareModalTopic)"
            >
              <ion-icon slot="start" name="close-outline"></ion-icon>
              Disable Sharing
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
