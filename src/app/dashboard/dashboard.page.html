<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title> Dashboard </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <div class="welcome-header">
    <h1 class="gradient-text">Hello, Learner! ðŸš€</h1>
    <p>Ready to crush your goals today?</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Loading your learning paths...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && learningTopics.length === 0" class="empty-state">
    <div class="empty-state-icon">
      <ion-icon name="rocket-outline"></ion-icon>
    </div>
    <h2>Start Your Learning Journey</h2>
    <p>
      You haven't added any skills yet. Create your first personalized learning
      roadmap powered by AI!
    </p>
    <ion-button
      expand="block"
      (click)="navigateToAddSkill()"
      class="cta-button"
    >
      <ion-icon slot="start" name="add-circle-outline"></ion-icon>
      Add Your First Skill
    </ion-button>
  </div>

  <!-- Learning Paths -->
  <div *ngIf="!isLoading && learningTopics.length > 0">
    <div class="section-header">
      <h2>My Learning Roadmaps</h2>
      <ion-button fill="clear" size="small" (click)="navigateToAddSkill()">
        <ion-icon slot="start" name="add-circle-outline"></ion-icon>
        Add New
      </ion-button>
    </div>

    <div *ngFor="let topic of learningTopics" class="roadmap-card">
      <!-- Roadmap Header -->
      <div class="roadmap-header" (click)="topic.expanded = !topic.expanded">
        <div class="roadmap-info">
          <h3>{{ topic.title }}</h3>
          <div class="roadmap-meta">
            <ion-chip
              [color]="topic.status === 'Completed' ? 'success' : (topic.status === 'Not Started' ? 'medium' : 'primary')"
              size="small"
            >
              {{ topic.status }}
            </ion-chip>
            <span class="category-tag"
              >{{ getCategoryLabel(topic.category) }}</span
            >
          </div>
        </div>
        <div class="roadmap-progress-circle">
          <svg viewBox="0 0 36 36">
            <path
              class="circle-bg"
              d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
            />
            <path
              class="circle-progress"
              [attr.stroke-dasharray]="(topic.progress * 100) + ', 100'"
              d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
            />
          </svg>
          <span class="progress-text"
            >{{ (topic.progress * 100) | number:'1.0-0' }}%</span
          >
        </div>
        <ion-icon
          [name]="topic.expanded ? 'chevron-up-outline' : 'chevron-down-outline'"
          class="expand-icon"
        ></ion-icon>
      </div>

      <!-- Progress Summary -->
      <div class="progress-summary">
        <span
          >{{ getCompletedSteps(topic) }} of {{ topic.subtasks.length }} steps
          completed</span
        >
        <span
          *ngIf="topic.resourcesStatus === 'loading' || topic.resourcesStatus === 'pending'"
          class="resources-loading-badge"
        >
          <ion-spinner name="dots" color="primary"></ion-spinner>
          Gathering resources...
        </span>
        <span
          *ngIf="topic.resourcesStatus === 'ready'"
          class="resources-ready-badge"
        >
          <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
          {{ getTotalResourceCount(topic) }} resources
        </span>
      </div>

      <!-- Regenerate Resources Button -->
      <div
        class="roadmap-actions"
        *ngIf="topic.resourcesStatus === 'ready' || topic.resourcesStatus === 'failed'"
      >
        <ion-button
          fill="outline"
          size="small"
          color="primary"
          (click)="regenerateResources(topic); $event.stopPropagation()"
          [disabled]="topic.resourcesStatus === 'loading'"
        >
          <ion-icon slot="start" name="refresh-outline"></ion-icon>
          Regenerate Resources
        </ion-button>
      </div>

      <!-- Roadmap Timeline -->
      <div *ngIf="topic.expanded" class="roadmap-timeline">
        <div
          *ngFor="let step of topic.subtasks; let i = index; let last = last"
          class="timeline-step"
          [class.completed]="step.completed"
        >
          <!-- Timeline Connector -->
          <div class="timeline-connector">
            <div class="step-number" [class.completed]="step.completed">
              <ion-icon *ngIf="step.completed" name="checkmark"></ion-icon>
              <span *ngIf="!step.completed">{{ i + 1 }}</span>
            </div>
            <div
              *ngIf="!last"
              class="connector-line"
              [class.completed]="step.completed"
            ></div>
          </div>

          <!-- Step Content -->
          <div class="step-content" [class.completed]="step.completed">
            <div class="step-header" (click)="step.expanded = !step.expanded">
              <div class="step-info">
                <h4>{{ step.title }}</h4>
                <div class="step-meta" *ngIf="step.estimatedTime">
                  <ion-icon name="time-outline"></ion-icon>
                  <span>{{ step.estimatedTime }}</span>
                </div>
              </div>
              <ion-checkbox
                [checked]="step.completed"
                (ionChange)="onSubtaskChange($event, step, topic)"
                (click)="$event.stopPropagation()"
              ></ion-checkbox>
            </div>

            <!-- Expanded Content -->
            <div *ngIf="step.expanded" class="step-details">
              <p class="step-description" *ngIf="step.description">
                {{ step.description }}
              </p>

              <!-- Resources Loading State -->
              <div *ngIf="isResourcesLoading(step)" class="resources-loading">
                <div class="loading-animation">
                  <ion-spinner name="crescent" color="primary"></ion-spinner>
                </div>
                <div class="loading-text">
                  <h5>Gathering verified resources...</h5>
                  <p>
                    Finding and validating the best learning materials for you
                  </p>
                </div>
                <div class="skeleton-resources">
                  <ion-skeleton-text
                    [animated]="true"
                    style="width: 100%; height: 50px; border-radius: 8px"
                  ></ion-skeleton-text>
                  <ion-skeleton-text
                    [animated]="true"
                    style="width: 100%; height: 50px; border-radius: 8px"
                  ></ion-skeleton-text>
                  <ion-skeleton-text
                    [animated]="true"
                    style="width: 80%; height: 50px; border-radius: 8px"
                  ></ion-skeleton-text>
                </div>
              </div>

              <!-- Resources Failed State -->
              <div
                *ngIf="step.resourcesStatus === 'failed' && (!step.resources || step.resources.length === 0)"
                class="resources-failed"
              >
                <ion-icon
                  name="alert-circle-outline"
                  color="warning"
                ></ion-icon>
                <p>Some resources couldn't be verified</p>
                <ion-button
                  fill="clear"
                  size="small"
                  (click)="retryResourceGathering(topic); $event.stopPropagation()"
                >
                  <ion-icon slot="start" name="refresh-outline"></ion-icon>
                  Retry
                </ion-button>
              </div>

              <!-- Resources Grid -->
              <div
                *ngIf="step.resourcesStatus === 'ready' && step.resources && step.resources.length > 0"
                class="resources-section"
              >
                <h5>
                  <ion-icon name="book-outline"></ion-icon>
                  Verified Resources
                  <ion-badge color="success" style="margin-left: 8px"
                    >{{ step.resources.length }}</ion-badge
                  >
                </h5>
                <div class="resources-grid">
                  <div
                    *ngFor="let resource of step.resources"
                    class="resource-card"
                    (click)="openResource(resource.url)"
                  >
                    <div class="resource-icon" [attr.data-type]="resource.type">
                      <ion-icon
                        [name]="getResourceIcon(resource.type)"
                      ></ion-icon>
                    </div>
                    <div class="resource-info">
                      <span class="resource-title">{{ resource.title }}</span>
                      <span class="resource-type">{{ resource.type }}</span>
                    </div>
                    <ion-icon name="open-outline" class="open-icon"></ion-icon>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ion-content>
